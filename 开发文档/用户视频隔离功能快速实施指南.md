# ç”¨æˆ·è§†é¢‘éš”ç¦»åŠŸèƒ½ - å¿«é€Ÿå®æ–½æŒ‡å—

## ğŸ“‹ æ¦‚è¿°
å°†å…¨å±€è§†é¢‘åˆ—è¡¨æ”¹ä¸ºç”¨æˆ·ä¸“å±ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·åªèƒ½çœ‹åˆ°å’Œç®¡ç†è‡ªå·±ä¸Šä¼ çš„è§†é¢‘ã€‚

## ğŸš€ å…³é”®ä¿®æ”¹ç‚¹

### 1. æ•°æ®åº“ä¿®æ”¹ (å¿…é¡»é¦–å…ˆæ‰§è¡Œ)

```sql
-- 1. æ·»åŠ ç”¨æˆ·å…³è”å­—æ®µ
ALTER TABLE videos ADD COLUMN user_id VARCHAR(36) NOT NULL;

-- 2. æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE videos ADD CONSTRAINT fk_videos_user_id 
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

-- 3. ä¼˜åŒ–æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_videos_user_id ON videos(user_id);
CREATE INDEX idx_videos_user_created ON videos(user_id, created_at DESC);

-- 4. å¤„ç†ç°æœ‰æ•°æ®ï¼ˆé€‰æ‹©å…¶ä¸€ï¼‰
-- æ–¹æ¡ˆA: åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·å½’å±ç°æœ‰è§†é¢‘
INSERT INTO users (id, phone, nickname, created_at) 
VALUES ('admin-user-id', 'admin', 'ç³»ç»Ÿç®¡ç†å‘˜', NOW());
UPDATE videos SET user_id = 'admin-user-id' WHERE user_id IS NULL;

-- æ–¹æ¡ˆB: åˆ é™¤ç°æœ‰æµ‹è¯•æ•°æ®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
-- DELETE FROM videos;
```

### 2. æ–°å¢åç«¯æ¥å£

#### A. ç”¨æˆ·è§†é¢‘åˆ—è¡¨
```python
@app.route('/api/user/videos', methods=['GET'])
@token_required
def get_user_videos(current_user):
    page = request.args.get('page', 1, type=int)
    per_page = min(request.args.get('per_page', 20, type=int), 50)
    
    videos = Video.query.filter_by(user_id=current_user.id)\
                       .order_by(Video.created_at.desc())\
                       .paginate(page=page, per_page=per_page, error_out=False)
    
    return jsonify({
        'success': True,
        'data': {
            'videos': [video.to_dict() for video in videos.items],
            'pagination': {
                'total': videos.total,
                'page': page,
                'per_page': per_page,
                'pages': videos.pages
            }
        }
    })
```

#### B. åˆ é™¤ç”¨æˆ·è§†é¢‘
```python
@app.route('/api/user/videos/<video_id>', methods=['DELETE'])
@token_required
def delete_user_video(current_user, video_id):
    video = Video.query.filter_by(id=video_id, user_id=current_user.id).first()
    if not video:
        return jsonify({'success': False, 'message': 'è§†é¢‘ä¸å­˜åœ¨æˆ–æ— æƒé™'}), 404
    
    # åˆ é™¤é€»è¾‘...
    db.session.delete(video)
    db.session.commit()
    
    return jsonify({'success': True, 'message': 'è§†é¢‘åˆ é™¤æˆåŠŸ'})
```

### 3. ä¿®æ”¹ç°æœ‰æ¥å£

#### A. è§†é¢‘ä¸Šä¼  - å…³è”ç”¨æˆ·
```python
@app.route('/api/videos/upload', methods=['POST'])
@token_required  # ç¡®ä¿éœ€è¦è®¤è¯
def upload_video(current_user):
    # ... ç°æœ‰é€»è¾‘ ...
    
    video = Video(
        id=video_id,
        filename=filename,
        user_id=current_user.id,  # å…³é”®ä¿®æ”¹ï¼šå…³è”ç”¨æˆ·
        # ... å…¶ä»–å­—æ®µ ...
    )
    db.session.add(video)
    db.session.commit()
```

#### B. æ‰€æœ‰è§†é¢‘è®¿é—®æ¥å£éƒ½éœ€è¦æƒé™æ£€æŸ¥
```python
# å­—å¹•è·å–
@app.route('/api/videos/<video_id>/subtitles', methods=['GET'])
@token_required
def get_video_subtitles(current_user, video_id):
    video = Video.query.filter_by(id=video_id, user_id=current_user.id).first()
    if not video:
        return jsonify({'success': False, 'message': 'æ— è®¿é—®æƒé™'}), 404
    # ... ç°æœ‰é€»è¾‘ ...

# è§†é¢‘æµæ’­æ”¾
@app.route('/api/videos/<video_id>/stream')
@token_required
def stream_video(current_user, video_id):
    video = Video.query.filter_by(id=video_id, user_id=current_user.id).first()
    if not video:
        return jsonify({'success': False, 'message': 'æ— è®¿é—®æƒé™'}), 404
    # ... ç°æœ‰é€»è¾‘ ...
```

### 4. å‰ç«¯ä¿®æ”¹ (å·²å®Œæˆ)

- âœ… æ›´æ–°äº† `VideoHistory.vue` ä½¿ç”¨ç”¨æˆ·ä¸“å±æ¥å£
- âœ… æ·»åŠ äº†ç™»å½•çŠ¶æ€æ£€æŸ¥å’Œè®¤è¯é”™è¯¯å¤„ç†
- âœ… æ›´æ–°äº† API é…ç½®å’ŒæœåŠ¡æ–¹æ³•

## ğŸ”§ éƒ¨ç½²æ­¥éª¤

### 1. æ•°æ®åº“è¿ç§»
```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u username -p database_name > backup.sql

# 2. æ‰§è¡Œè¡¨ç»“æ„ä¿®æ”¹
mysql -u username -p database_name < migration.sql

# 3. éªŒè¯ä¿®æ”¹
mysql -u username -p -e "DESCRIBE videos;" database_name
```

### 2. åç«¯ä»£ç éƒ¨ç½²
```bash
# 1. æ·»åŠ æ–°çš„è·¯ç”±å’Œæƒé™æ£€æŸ¥
# 2. ä¿®æ”¹ç°æœ‰è§†é¢‘ç›¸å…³æ¥å£
# 3. æµ‹è¯•æ‰€æœ‰æ¥å£çš„æƒé™æ§åˆ¶
# 4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
```

### 3. å‰ç«¯ä»£ç éƒ¨ç½²
```bash
# å‰ç«¯ä¿®æ”¹å·²å®Œæˆï¼Œç›´æ¥éƒ¨ç½²å³å¯
npm run build
```

## âœ… éªŒè¯æ¸…å•

### åç«¯éªŒè¯
- [ ] ç”¨æˆ·åªèƒ½è·å–è‡ªå·±çš„è§†é¢‘åˆ—è¡¨
- [ ] ç”¨æˆ·æ— æ³•è®¿é—®ä»–äººçš„è§†é¢‘è¯¦æƒ…
- [ ] ç”¨æˆ·æ— æ³•åˆ é™¤ä»–äººçš„è§†é¢‘
- [ ] è§†é¢‘ä¸Šä¼ æ­£ç¡®å…³è”å½“å‰ç”¨æˆ·
- [ ] æ‰€æœ‰æ¥å£éƒ½æœ‰é€‚å½“çš„æƒé™æ£€æŸ¥

### å‰ç«¯éªŒè¯
- [ ] æœªç™»å½•ç”¨æˆ·çœ‹åˆ°ç™»å½•æç¤º
- [ ] ç™»å½•ç”¨æˆ·åªçœ‹åˆ°è‡ªå·±çš„è§†é¢‘
- [ ] è®¤è¯è¿‡æœŸæ—¶æ­£ç¡®è·³è½¬ç™»å½•é¡µ
- [ ] åˆ é™¤æ“ä½œåªå½±å“ç”¨æˆ·è‡ªå·±çš„è§†é¢‘

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**: å¿…é¡»å…ˆå¤„ç†ç°æœ‰è§†é¢‘æ•°æ®çš„ç”¨æˆ·å½’å±
2. **æƒé™æ£€æŸ¥**: æ‰€æœ‰è§†é¢‘ç›¸å…³æ¥å£éƒ½å¿…é¡»æ·»åŠ ç”¨æˆ·æƒé™éªŒè¯
3. **é”™è¯¯å¤„ç†**: å‰ç«¯éœ€è¦æ­£ç¡®å¤„ç†401/403/404ç­‰æƒé™é”™è¯¯
4. **æ€§èƒ½ä¼˜åŒ–**: æ·»åŠ åˆé€‚çš„æ•°æ®åº“ç´¢å¼•
5. **æµ‹è¯•è¦†ç›–**: ç¡®ä¿æ‰€æœ‰ç”¨æˆ·éš”ç¦»åœºæ™¯éƒ½æœ‰æµ‹è¯•è¦†ç›–

## ğŸ“ æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·å‚è€ƒå®Œæ•´çš„ã€Šç”¨æˆ·è§†é¢‘éš”ç¦»åŠŸèƒ½APIæ¥å£æ–‡æ¡£.mdã€‹è·å–è¯¦ç»†ä¿¡æ¯ã€‚ 