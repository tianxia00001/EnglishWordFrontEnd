# 英语学习助手 · 用户体系与会员体系技术文档
版本：v3.0.0 | 日期：2024-12-20

## 📋 概述

### 业务目标
在现有英语学习助手基础上，构建完整的用户体系和会员付费体系，实现：
- 用户注册登录和数据隔离
- 免费用户和VIP用户分级服务
- 支付宝和微信支付集成
- 个性化学习内容推荐

### 系统架构
```
匿名用户 → 注册用户(免费) → VIP会员(付费)
   ↓          ↓              ↓
基础体验    标准功能      全功能 + 专属
   ↓          ↓              ↓
无存储     限制配额       无限制使用
```

## 🗄️ 数据模型设计

### 1. 用户表 (users)
```sql
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    phone VARCHAR(20) UNIQUE NOT NULL,        -- 手机号
    nickname VARCHAR(50),
    avatar_url VARCHAR(255),
    verification_code_hash VARCHAR(128),      -- 最近一次验证码哈希/加盐存储
    
    -- 会员信息
    membership_type VARCHAR(20) DEFAULT 'free',  -- free/vip
    is_vip_active BOOLEAN DEFAULT FALSE,
    vip_expires_at DATETIME,
    
    -- 日额度字段
    daily_learning_sessions INTEGER DEFAULT 0,
    daily_ai_questions INTEGER DEFAULT 0,
    daily_story_generations INTEGER DEFAULT 0,
    daily_translations INTEGER DEFAULT 0,
    personal_word_count INTEGER DEFAULT 0,
    
    -- 元数据
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME,
    last_quota_reset DATE
);
```

### 2. 会员套餐表 (membership_plans)
```sql
CREATE TABLE membership_plans (
    id INTEGER PRIMARY KEY,
    plan_type VARCHAR(20) NOT NULL,  -- monthly/yearly
    name VARCHAR(100) NOT NULL,
    duration_days INTEGER NOT NULL,
    original_price DECIMAL(10,2) NOT NULL,
    current_price DECIMAL(10,2) NOT NULL,
    discount_text VARCHAR(50),
    features JSON,
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INTEGER DEFAULT 0
);
```

### 3. 订单表 (orders)
```sql
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    order_no VARCHAR(32) UNIQUE NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    plan_id INTEGER NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    expires_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (plan_id) REFERENCES membership_plans(id)
);
```

### 4. 支付记录表 (payments)
```sql
CREATE TABLE payments (
    id INTEGER PRIMARY KEY,
    order_id INTEGER NOT NULL,
    payment_method VARCHAR(20) NOT NULL,  -- alipay/wechat
    trade_no VARCHAR(64),
    amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    paid_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

### 5. 用户数据关联表
```sql
-- 用户单词表
CREATE TABLE user_words (
    id INTEGER PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    word_text VARCHAR(100) NOT NULL,
    translation VARCHAR(255),
    category_id INTEGER,
    is_learned BOOLEAN DEFAULT FALSE,
    learned_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 用户学习会话
CREATE TABLE user_learning_sessions (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    video_id VARCHAR(36) NOT NULL,
    session_type VARCHAR(50),
    status VARCHAR(20),
    progress INTEGER DEFAULT 0,
    completed_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## 🔐 认证与权限

### JWT认证流程
```
1. 客户端请求 `/api/auth/send-code` 发送验证码 → 服务端生成6位验证码并缓存 → （测试环境直接返回验证码）
2. 用户输入验证码调用 `/api/auth/login` → 服务端校验验证码 → 生成JWT Token
3. 客户端携带Token访问受保护接口 → 服务端验证 → 获取用户信息
4. Token过期 → 调用 `/api/auth/refresh` 刷新Token 或重新获取验证码登录
```

### 权限等级定义
| 功能模块 | 匿名用户 | 免费用户 | VIP会员 |
|----------|----------|----------|---------|
| 视频观看 | ✅ 3个/天 | ✅ 10个/天 | ✅ 无限制 |
| 学习会话 | ❌ | ✅ 5个/天 | ✅ 无限制 |
| 个人单词本 | ❌ | ✅ 200词 | ✅ 无限制 |
| AI问题生成 | ❌ | ✅ 10次/天 | ✅ 无限制 |
| 故事生成 | ❌ | ✅ 3个/天 | ✅ 无限制 |
| 离线下载 | ❌ | ❌ | ✅ 支持 |

## 🌐 API接口设计

### 用户认证接口

#### 1. 用户注册
```
POST /api/auth/register
Content-Type: application/json

{
    "phone": "13800138000",
    "verification_code": "123456",
    "nickname": "测试用户"
}

Response:
{
    "success": true,
    "message": "注册成功",
    "data": {
        "user_id": "uuid",
        "phone": "13800138000",
        "access_token": "jwt_token",
        "expires_in": 3600
    }
}
```

#### 2. 用户登录
```
POST /api/auth/login
Content-Type: application/json

{
    "phone": "13800138000",
    "verification_code": "123456"
}

Response:
{
    "success": true,
    "data": {
        "user_id": "uuid",
        "phone": "13800138000",
        "membership_type": "free",
        "is_vip_active": false,
        "access_token": "jwt_token",
        "expires_in": 3600
    }
}
```

#### 3. 获取用户信息
```
GET /api/auth/profile
Authorization: Bearer {jwt_token}

Response:
{
    "success": true,
    "data": {
        "id": "uuid",
        "phone": "13800138000",
        "membership_type": "free",
        "daily_quotas": {
            "learning_sessions": "3/5",
            "ai_questions": "5/10",
            "story_generations": "1/3"
        },
        "vip_info": {
            "is_active": false,
            "expires_at": null
        }
    }
}
```

### 会员相关接口

#### 1. 获取套餐列表
```
GET /api/membership/plans

Response:
{
    "success": true,
    "data": [
        {
            "id": 1,
            "plan_type": "monthly",
            "name": "VIP月卡",
            "duration_days": 30,
            "original_price": 29.9,
            "current_price": 19.9,
            "discount_text": "限时优惠",
            "features": [
                "无限学习会话",
                "无限AI问题生成",
                "专属学习内容",
                "离线下载功能"
            ]
        },
        {
            "id": 2,
            "plan_type": "yearly",
            "name": "VIP年卡",
            "duration_days": 365,
            "original_price": 298.0,
            "current_price": 199.0,
            "discount_text": "立省99元"
        }
    ]
}
```

#### 2. 创建订单
```
POST /api/membership/orders
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
    "plan_id": 1
}

Response:
{
    "success": true,
    "data": {
        "order_no": "ORDER_20241220_001",
        "amount": 19.9,
        "expires_at": "2024-12-20T10:30:00Z"
    }
}
```

#### 3. 发起支付
```
POST /api/membership/payments
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
    "order_no": "ORDER_20241220_001",
    "payment_method": "alipay"  // alipay/wechat
}

Response:
{
    "success": true,
    "data": {
        "payment_url": "https://payment.alipay.com/...",
        "qr_code": "data:image/png;base64,..."  // 微信支付二维码
    }
}
```

#### 4. 支付状态查询
```
GET /api/membership/payments/{order_no}/status
Authorization: Bearer {jwt_token}

Response:
{
    "success": true,
    "data": {
        "status": "success",  // pending/success/failed/expired
        "paid_at": "2024-12-20T10:15:00Z",
        "vip_expires_at": "2025-01-20T10:15:00Z"
    }
}
```

### 用户数据接口

#### 1. 获取用户单词本
```
GET /api/user/words?page=1&per_page=20&category_id=1
Authorization: Bearer {jwt_token}

Response:
{
    "success": true,
    "data": {
        "words": [
            {
                "id": 1,
                "word_text": "example",
                "translation": "例子",
                "is_learned": true,
                "learned_at": "2024-12-20T10:00:00Z"
            }
        ],
        "total": 50,
        "page": 1,
        "per_page": 20
    }
}
```

#### 2. 添加用户单词
```
POST /api/user/words
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
    "word_text": "technology",
    "translation": "技术",
    "category_id": 1
}

Response:
{
    "success": true,
    "message": "单词添加成功",
    "data": {
        "id": 101,
        "word_text": "technology"
    }
}
```

## 💾 数据迁移方案

### 现有数据兼容性
```python
# 软迁移策略 - 保持向下兼容
def migrate_existing_data():
    """
    将现有匿名数据迁移到用户体系
    1. 为现有数据添加 user_id 字段(可为空)
    2. 匿名用户继续使用现有逻辑
    3. 登录用户使用新的数据隔离逻辑
    """
    
    # 添加用户关联字段到现有表
    alter_statements = [
        "ALTER TABLE learning_session ADD COLUMN user_id VARCHAR(36)",
        "ALTER TABLE word ADD COLUMN user_id VARCHAR(36)",
        "ALTER TABLE story ADD COLUMN user_id VARCHAR(36)"
    ]
    
    # 创建索引
    index_statements = [
        "CREATE INDEX idx_learning_session_user_id ON learning_session(user_id)",
        "CREATE INDEX idx_word_user_id ON word(user_id)",
        "CREATE INDEX idx_story_user_id ON story(user_id)"
    ]
```

## 🔒 安全考虑

### 1. 密码安全 → **已废弃（改用验证码登录）**
> 旧密码哈希相关内容已移除。

### 2. JWT令牌安全
```python
# JWT配置
JWT_SECRET_KEY = 'your-secret-key'
JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=24)
JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)

# 令牌生成
access_token = create_access_token(
    identity=user.id,
    expires_delta=timedelta(hours=24)
)
```

### 3. 支付安全
- 订单防重复提交
- 支付金额校验
- 第三方支付回调验证
- 敏感信息加密存储

### 1. 验证码安全
- 验证码长度：6 位数字，5 分钟内有效
- 同一手机号 60 秒内只能请求一次验证码，单日最多 10 次
- 生产环境通过短信服务商发送；测试环境直接返回验证码
- 采用哈希+过期时间存储验证码，防止明文泄露

## 🚀 实施计划

### 第一阶段：核心认证系统 (1周)
- [ ] 用户模型和认证API
- [ ] JWT集成和权限装饰器
- [ ] 基础用户界面

### 第二阶段：数据关联 (1周)
- [ ] 用户数据模型关联
- [ ] 现有API改造
- [ ] 数据迁移脚本

### 第三阶段：会员体系 (2周)
- [ ] 会员套餐管理
- [ ] 订单和支付流程
- [ ] 权限控制实现

### 第四阶段：集成测试 (1周)
- [ ] 完整流程测试
- [ ] 性能优化
- [ ] 文档完善

## 📊 监控指标

### 业务指标
- 注册用户数和增长率
- VIP转化率和留存率
- 日活跃用户数
- 付费用户收入

### 技术指标
- API响应时间
- 数据库查询性能
- 错误率和异常监控
- 服务可用性

## 📝 部署配置

### 环境变量
```bash
# 数据库
DATABASE_URL=sqlite:///english_learning.db

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ACCESS_TOKEN_EXPIRES=86400

# 支付配置
ALIPAY_APP_ID=your-alipay-app-id
ALIPAY_PRIVATE_KEY=your-private-key
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-secret

# 邮件配置(可选)
MAIL_SERVER=smtp.gmail.com
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-password
```

### 数据库初始化
```bash
# 创建表结构
python scripts/init_user_system.py

# 初始化会员套餐
python scripts/init_membership_plans.py

# 数据迁移(可选)
python scripts/migrate_existing_data.py
```

---

**文档版本**: v3.0.0  
**更新时间**: 2024-12-20  
**维护团队**: 后端开发团队 